""" Console Output
+--------+--------+---------------+---------------+---------------+
| cust   | prod   |   1_min_quant |   2_max_quant |   3_avg_quant |
|--------+--------+---------------+---------------+---------------|
| Dan    | Ham    |           305 |           967 |       635.947 |
| Claire | Fish   |           330 |           990 |       617.053 |
| Dan    | Apple  |           209 |           937 |       698.893 |
| Chae   | Jelly  |           260 |           914 |       702.091 |
| Chae   | Ham    |           211 |           992 |       637.45  |
| Mia    | Fish   |           329 |           937 |       628.913 |
| Mia    | Dates  |           222 |           855 |       577.92  |
| Dan    | Butter |           225 |           982 |       570.13  |
| Sam    | Jelly  |           219 |           997 |       570.37  |
| Wally  | Cherry |           263 |           971 |       635     |
| Chae   | Apple  |           215 |           981 |       637.588 |
| Helen  | Butter |           282 |           933 |       569.962 |
| Chae   | Eggs   |           218 |           994 |       600.538 |
| Dan    | Dates  |           217 |           992 |       579.108 |
| Chae   | Dates  |           231 |           991 |       644.19  |
| Dan    | Grapes |           219 |           998 |       587.467 |
| Wally  | Ham    |           262 |           994 |       580     |
| Helen  | Ham    |           260 |           897 |       575.6   |
| Helen  | Grapes |           248 |           988 |       612.8   |
| Claire | Grapes |           217 |           992 |       565.24  |
| Helen  | Cherry |           218 |           965 |       529.667 |
| Emily  | Cherry |           217 |           923 |       565.882 |
| Dan    | Fish   |           229 |           986 |       692.105 |
| Sam    | Ham    |           233 |           972 |       602.815 |
| Sam    | Ice    |           239 |           993 |       557.083 |
| Claire | Jelly  |           221 |           914 |       624.125 |
| Helen  | Ice    |           202 |           979 |       530.087 |
| Dan    | Eggs   |           230 |           974 |       633.526 |
| Claire | Butter |           351 |           980 |       602.52  |
| Mia    | Eggs   |           244 |           976 |       633.227 |
| Boo    | Dates  |           208 |          1000 |       604.619 |
| Dan    | Jelly  |           350 |           996 |       708.389 |
| Sam    | Grapes |           250 |           943 |       566.905 |
| Boo    | Ham    |           214 |           999 |       578.579 |
| Chae   | Butter |           238 |           972 |       617.739 |
| Mia    | Jelly  |           210 |           997 |       642.68  |
| Emily  | Ice    |           247 |           968 |       508     |
| Emily  | Ham    |           254 |           978 |       592.692 |
| Dan    | Ice    |           206 |           966 |       704.933 |
| Claire | Cherry |           203 |           961 |       609.708 |
| Boo    | Ice    |           262 |           977 |       484.727 |
| Emily  | Butter |           210 |           950 |       625.526 |
| Claire | Apple  |           305 |           929 |       632.222 |
| Chae   | Ice    |           240 |           998 |       643.276 |
| Sam    | Cherry |           201 |          1000 |       617.857 |
| Boo    | Fish   |           210 |           903 |       645.059 |
| Chae   | Grapes |           222 |           992 |       557     |
| Emily  | Apple  |           212 |           975 |       553     |
| Wally  | Grapes |           236 |           966 |       618.148 |
| Boo    | Apple  |           307 |           972 |       617.409 |
| Helen  | Dates  |           282 |           987 |       672.545 |
| Sam    | Dates  |           240 |           988 |       599.421 |
| Mia    | Butter |           221 |           953 |       587.429 |
| Wally  | Dates  |           231 |           837 |       577.292 |
| Chae   | Fish   |           227 |           987 |       594.579 |
| Mia    | Ham    |           244 |           983 |       594.214 |
| Mia    | Cherry |           215 |           949 |       505.529 |
| Sam    | Eggs   |           267 |           992 |       610.862 |
| Helen  | Jelly  |           220 |           977 |       542.15  |
| Wally  | Apple  |           264 |           948 |       554.361 |
| Claire | Ham    |           249 |           982 |       656.536 |
| Boo    | Eggs   |           211 |           990 |       612.964 |
| Wally  | Butter |           383 |           974 |       583.9   |
| Boo    | Cherry |           232 |          1000 |       597.5   |
| Helen  | Eggs   |           205 |           998 |       583.783 |
| Boo    | Grapes |           218 |           939 |       561.385 |
| Wally  | Ice    |           211 |           949 |       601.875 |
| Sam    | Apple  |           240 |           888 |       588     |
| Helen  | Fish   |           208 |           986 |       663.318 |
| Helen  | Apple  |           256 |           974 |       684.438 |
| Emily  | Fish   |           229 |           973 |       508.556 |
| Dan    | Cherry |           204 |           995 |       661     |
| Emily  | Dates  |           246 |           995 |       651.238 |
| Claire | Dates  |           203 |           999 |       592.25  |
| Wally  | Fish   |           205 |           982 |       601.833 |
| Mia    | Ice    |           211 |           987 |       522     |
| Emily  | Eggs   |           212 |           976 |       546.609 |
| Wally  | Jelly  |           214 |          1000 |       652     |
| Wally  | Eggs   |           218 |           934 |       566.444 |
| Claire | Eggs   |           235 |           887 |       613.714 |
| Boo    | Jelly  |           223 |           964 |       547.818 |
| Mia    | Grapes |           209 |           983 |       559.957 |
| Emily  | Jelly  |           209 |           845 |       588.5   |
| Mia    | Apple  |           215 |           989 |       655.567 |
| Chae   | Cherry |           309 |           993 |       533.6   |
| Emily  | Grapes |           227 |           978 |       565.667 |
| Boo    | Butter |           395 |           993 |       635     |
| Claire | Ice    |           221 |           960 |       518.522 |
| Sam    | Fish   |           221 |           930 |       510.607 |
| Sam    | Butter |           251 |           972 |       639.773 |
+--------+--------+---------------+---------------+---------------+
"""

import os
import psycopg2
import psycopg2.extras
import tabulate
from dotenv import load_dotenv
from helper import inputHandler, createMFStructEntry, lookup
from collections import defaultdict
import re

# DO NOT EDIT THIS FILE, IT IS GENERATED BY generator.py

def query():
    load_dotenv()

    user = os.getenv('DB_USER')
    password = os.getenv('DB_PASSWORD')
    dbname = os.getenv('DB_NAME')

    conn = psycopg2.connect(
    dbname=dbname, user=user, password=password, host="localhost", port=5433, cursor_factory=psycopg2.extras.DictCursor)
    
    cur = conn.cursor()
    cur.execute("SELECT * FROM sales")
    
    phi = {'s': ['cust', 'prod', '1_min_quant', '2_max_quant', '3_avg_quant'], 'n': 3, 'v': ['cust', 'prod'], 'f': ['1_min_quant', '2_max_quant', '3_avg_quant'], 'sigma': ["1.state='NJ' and 1.quant > 200", "2.state='NY' and 2.quant > 200", "3.state='CT' and 3.quant > 200"]}

    # convert phi from list to dictionary with keys as gv for simpler condition checking
    if 'sigma' in phi.keys():
        original_sigma_list = phi['sigma']
        phi['sigma'] = defaultdict(list)

        for cond in original_sigma_list:
            gv, expr = cond.split('.', 1)
            # Remove all gv prefixes like "1." â†’ "cust", "quant"
            expr = re.sub(r'(?<!\w)(\d+)\.', '', expr)

            # Normalize single '=' to '==', but don't change >=, <=, !=, ==
            expr = re.sub(r'(?<![<>=!])=(?![=])', '==', expr)

            # Lowercase all standalone ANDs
            expr = re.sub(r'AND', 'and', expr, flags=re.IGNORECASE)

            # Append cleaned expression
            phi['sigma'][gv].append(expr.strip())

    MF_Struct = []
    
    
    for row in cur:
        # create a tuple of current row's grouping attribute values
        grouping_key = tuple(row[attr] for attr in phi['v'])

        # search MF_Struct to see if grouping_key already exists
        search_index = lookup(MF_Struct, phi['v'], grouping_key)

        # if it does not exist, create an entry in MF_Struct list
        if search_index == -1:
          
            new_entry = createMFStructEntry(phi, row)
            MF_Struct.append(new_entry)

        # if it already exists, update aggregates based on attribute values
        else:
            for s in phi['f']:
                parts = s.split('_')

                if len(parts) == 3:
                    gv, agg, attr = parts
                elif len(parts) == 2:
                    gv = ''
                    agg, attr = parts
                else:
                    raise ValueError(f"Unexpected aggregate format: {s}")
                
                if gv in phi.get('sigma', {}):
                    conditions = phi['sigma'][gv]
                    if not all(eval(cond, {}, row) for cond in conditions):
                        continue  # Skip update if condition not met
        
                if agg == 'count':
                    MF_Struct[search_index][s] += 1

                elif agg == 'sum':
                    MF_Struct[search_index][s] += row[attr]

                elif agg == 'min':
                    MF_Struct[search_index][s] = min(MF_Struct[search_index][s], row[attr])

                elif agg == 'max':
                    MF_Struct[search_index][s] = max(MF_Struct[search_index][s], row[attr])

                elif agg == 'avg':

                    sum_key = f"{gv}_sum_{attr}" if gv else f"sum_{attr}"
                    count_key = f"{gv}_count_{attr}" if gv else f"count_{attr}"

                    if sum_key not in phi['f']:
                        MF_Struct[search_index][sum_key] += row[attr]
                    if count_key not in phi['f']:
                        MF_Struct[search_index][count_key] += 1

                    MF_Struct[search_index][s] = MF_Struct[search_index][sum_key] / MF_Struct[search_index][count_key]

                else:
                    MF_Struct[search_index] = None
    
    #remove any attributes used for calculation and not in select clause
    for entry in MF_Struct:
        for key in list(entry.keys()):
            if key not in phi['s']:
                del entry[key]
    
    
    
    return tabulate.tabulate(MF_Struct,
                        headers="keys", tablefmt="psql")

def main():
    print(query())
    
if "__main__" == __name__:
    main()
    